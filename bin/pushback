#!/bin/bash

set -o errexit
set -o xtrace

[[ ${CHIRP_PUSHBACK_DISABLED} ]] && { echo "Disabled!" ; exit 0 ; }
[[ ${GITHUB_OAUTH_TOKEN} ]] || { echo "Missing \$GITHUB_OAUTH_TOKEN" ; exit 1 ; }
[[ ${TRAVIS_REPO_SLUG} ]] || { echo "Missing \$TRAVIS_REPO_SLUG" ; exit 1 ; }

git checkout master
git pull --rebase origin master
[[ $TRAVIS ]] && git config --global user.name 'Travis CI'
[[ $TRAVIS ]] && git config --global user.email 'contact+chirp@travis-ci.org'
git commit --allow-empty -m "Bump self after commit ${TRAVIS_COMMIT}

Travis-Build-ID: ${TRAVIS_BUILD_ID}
Travis-Job-ID: ${TRAVIS_JOB_ID}
Travis-Commit: ${TRAVIS_COMMIT}
"

(
  set +x
  git remote set-url origin "https://${GITHUB_OAUTH_TOKEN}:x-oauth-basic@github.com/${TRAVIS_REPO_SLUG}.git"
)

git push --quiet origin master
